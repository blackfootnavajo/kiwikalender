<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalender 2025/2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; background-color: white; }
            .no-print { display: none !important; }
            .max-w-7xl { max-width: 100% !important; margin: 0 !important; padding: 0 !important; }
        }

        .day-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            transition: all 0.1s;
            position: relative;
        }

        .edit-mode .day-cell { cursor: pointer; }
        .edit-mode .day-cell:hover { background-color: #f3f4f6; }

        .day-cell.marked {
            background-color: #ef4444 !important;
            color: white;
            font-weight: bold;
        }

        .chart-container {
            position: relative;
            height: 150px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">

    <div id="calendar-content" class="max-w-7xl mx-auto">
        
        <!-- Header / Controls -->
        <div class="flex flex-col xl:flex-row justify-between items-center mb-8 no-print gap-6">
            <div class="text-center xl:text-left">
                <div class="flex items-center gap-4 justify-center xl:justify-start">
                    <h1 class="text-xl font-bold text-gray-800" id="year-display">2025</h1>
                    <button id="edit-toggle" onclick="toggleEditMode()" class="flex items-center gap-2 px-3 py-1 rounded-full border-2 transition-all font-semibold text-xs border-gray-300 text-gray-500 bg-white">
                        <span id="edit-status-dot" class="w-2 h-2 rounded-full bg-gray-300"></span>
                        <span id="edit-text">Bearbeiten AUS</span>
                    </button>
                </div>
            </div>
            
            <div class="flex flex-col md:flex-row gap-4 items-center">
                <!-- Year Switcher -->
                <div class="flex bg-white rounded-lg p-1 shadow-sm border border-gray-200">
                    <button onclick="setYear(2025)" id="btn-2025" class="px-3 py-1.5 rounded-md text-xs font-medium transition bg-gray-100 text-gray-900 shadow-sm">2025</button>
                    <button onclick="setYear(2026)" id="btn-2026" class="px-3 py-1.5 rounded-md text-xs font-medium transition text-gray-500 hover:text-gray-900">2026</button>
                </div>

                <!-- Actions -->
                <div class="flex gap-2 flex-wrap justify-center">
                    <button onclick="openDayModal()" class="bg-blue-50 hover:bg-blue-100 text-blue-700 px-3 py-1.5 rounded-lg font-medium text-xs transition border border-blue-200 flex items-center gap-2">
                        Wochentage
                    </button>
                    <button onclick="clearAll()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1.5 rounded-lg font-medium text-xs transition">
                        Löschen
                    </button>
                </div>

                <!-- File Operations -->
                <div class="flex gap-2 flex-wrap justify-center border-l pl-0 md:pl-4 border-gray-300">
                    <button onclick="downloadPDF()" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg font-medium text-xs transition shadow-sm flex items-center gap-2">
                        PDF
                    </button>
                    <button onclick="downloadJSON()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg font-medium text-xs transition shadow-sm flex items-center gap-2">
                        JSON
                    </button>
                    <label class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-3 py-1.5 rounded-lg font-medium text-xs transition shadow-sm flex items-center gap-2 cursor-pointer">
                        Laden
                        <input type="file" id="file-input" accept=".json" class="hidden" onchange="uploadJSON(this)">
                    </label>
                </div>
            </div>
        </div>

        <!-- Statistics Section -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-10 no-print">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">Wöchentlich (KW)</h3>
                <div class="chart-container">
                    <canvas id="weekChart"></canvas>
                </div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">Wochentage</h3>
                <div class="chart-container">
                    <canvas id="weekdayChart"></canvas>
                </div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-center items-center">
                <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2 text-center">Gesamt <span id="stat-year">2025</span></h3>
                <div class="text-4xl font-bold text-red-500" id="total-count">0</div>
                <div class="text-[10px] text-gray-400 mt-1 uppercase">Termine</div>
            </div>
        </div>

        <!-- Calendar Container -->
        <div id="calendar-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Months will be generated here -->
        </div>

    </div>

    <!-- Modal for selecting weekdays -->
    <div id="day-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4 no-print">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full transform transition-all scale-100">
            <h3 class="text-xl font-bold text-gray-800 mb-2">Wochentage markieren</h3>
            <p class="text-sm text-gray-500 mb-5">Wählen Sie die Tage für das Jahr <span id="modal-year" class="font-bold"></span>.</p>
            <p class="text-[10px] text-blue-500 mb-4 italic">* Es werden nur Termine bis zum heutigen Tag eingetragen.</p>
            
            <div class="space-y-2 mb-6">
                <label class="flex items-center p-2 hover:bg-gray-50 rounded-lg cursor-pointer transition">
                    <input type="checkbox" value="1" class="w-5 h-5 text-blue-600 rounded border-gray-300">
                    <span class="ml-3 text-gray-700">Montag</span>
                </label>
                <label class="flex items-center p-2 hover:bg-gray-50 rounded-lg cursor-pointer transition">
                    <input type="checkbox" value="2" class="w-5 h-5 text-blue-600 rounded border-gray-300">
                    <span class="ml-3 text-gray-700">Dienstag</span>
                </label>
                <label class="flex items-center p-2 hover:bg-gray-50 rounded-lg cursor-pointer transition">
                    <input type="checkbox" value="3" class="w-5 h-5 text-blue-600 rounded border-gray-300">
                    <span class="ml-3 text-gray-700">Mittwoch</span>
                </label>
                <label class="flex items-center p-2 hover:bg-gray-50 rounded-lg cursor-pointer transition">
                    <input type="checkbox" value="4" class="w-5 h-5 text-blue-600 rounded border-gray-300">
                    <span class="ml-3 text-gray-700">Donnerstag</span>
                </label>
                <label class="flex items-center p-2 hover:bg-gray-50 rounded-lg cursor-pointer transition">
                    <input type="checkbox" value="5" class="w-5 h-5 text-blue-600 rounded border-gray-300">
                    <span class="ml-3 text-gray-700">Freitag</span>
                </label>
                <label class="flex items-center p-2 hover:bg-gray-50 rounded-lg cursor-pointer transition">
                    <input type="checkbox" value="6" class="w-5 h-5 text-blue-600 rounded border-gray-300">
                    <span class="ml-3 text-gray-700">Samstag</span>
                </label>
                <label class="flex items-center p-2 hover:bg-gray-50 rounded-lg cursor-pointer transition">
                    <input type="checkbox" value="0" class="w-5 h-5 text-blue-600 rounded border-gray-300">
                    <span class="ml-3 text-gray-700">Sonntag</span>
                </label>
            </div>

            <div class="flex gap-3 justify-end pt-2 border-t border-gray-100">
                <button onclick="closeDayModal()" class="px-4 py-2 text-gray-500 hover:text-gray-800 text-sm font-medium">Abbrechen</button>
                <button onclick="markSelectedDays()" class="px-5 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition text-sm font-medium">Hinzufügen</button>
            </div>
        </div>
    </div>

    <script>
        const months = ["Januar", "Februar", "März", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"];
        const daysShort = ["Mo", "Di", "Mi", "Do", "Fr", "Sa", "So"];
        
        // State
        let currentYear = 2025;
        let isEditMode = false;
        let markedDates = new Set();
        let weekdayChart, weekChart;

        function getISOWeek(dateString) {
            const date = new Date(dateString);
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const toggleBtn = document.getElementById('edit-toggle');
            const statusDot = document.getElementById('edit-status-dot');
            const statusText = document.getElementById('edit-text');
            const container = document.getElementById('calendar-container');

            if (isEditMode) {
                toggleBtn.classList.replace('border-gray-300', 'border-red-500');
                toggleBtn.classList.replace('text-gray-500', 'text-red-600');
                statusDot.classList.replace('bg-gray-300', 'bg-red-500');
                statusText.innerText = "Bearbeiten AN";
                container.classList.add('edit-mode');
            } else {
                toggleBtn.classList.replace('border-red-500', 'border-gray-300');
                toggleBtn.classList.replace('text-red-600', 'text-gray-500');
                statusDot.classList.replace('bg-red-500', 'bg-gray-300');
                statusText.innerText = "Bearbeiten AUS";
                container.classList.remove('edit-mode');
            }
        }

        function setYear(year) {
            currentYear = year;
            document.getElementById('year-display').innerText = year;
            document.getElementById('stat-year').innerText = year;
            
            const btn2025 = document.getElementById('btn-2025');
            const btn2026 = document.getElementById('btn-2026');
            
            if (year === 2025) {
                btn2025.className = "px-3 py-1.5 rounded-md text-xs font-medium transition bg-gray-100 text-gray-900 shadow-sm";
                btn2026.className = "px-3 py-1.5 rounded-md text-xs font-medium transition text-gray-500 hover:text-gray-900";
            } else {
                btn2025.className = "px-3 py-1.5 rounded-md text-xs font-medium transition text-gray-500 hover:text-gray-900";
                btn2026.className = "px-3 py-1.5 rounded-md text-xs font-medium transition bg-gray-100 text-gray-900 shadow-sm";
            }
            initCalendar();
        }

        function initCalendar() {
            const grid = document.getElementById('calendar-container');
            grid.innerHTML = '';

            months.forEach((monthName, index) => {
                const monthDiv = document.createElement('div');
                monthDiv.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 break-inside-avoid month-card";
                
                const title = document.createElement('h2');
                title.className = "text-sm font-bold text-gray-800 mb-3 text-center";
                title.innerText = monthName;
                monthDiv.appendChild(title);

                const daysHeader = document.createElement('div');
                daysHeader.className = "grid grid-cols-7 gap-1 mb-2";
                daysShort.forEach(day => {
                    const d = document.createElement('div');
                    d.className = "text-center text-[10px] font-semibold text-gray-400";
                    d.innerText = day;
                    daysHeader.appendChild(d);
                });
                monthDiv.appendChild(daysHeader);

                const daysGrid = document.createElement('div');
                daysGrid.className = "grid grid-cols-7 gap-1";

                const firstDay = new Date(currentYear, index, 1);
                let startDay = firstDay.getDay(); 
                startDay = (startDay === 0) ? 6 : startDay - 1;

                const daysInMonth = new Date(currentYear, index + 1, 0).getDate();

                for (let i = 0; i < startDay; i++) {
                    daysGrid.appendChild(document.createElement('div'));
                }

                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = `${currentYear}-${String(index + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const cell = document.createElement('div');
                    cell.className = "day-cell text-xs text-gray-700";
                    cell.innerText = d;
                    
                    if (markedDates.has(dateStr)) cell.classList.add('marked');

                    cell.onclick = () => {
                        if (isEditMode) toggleDate(dateStr);
                    };
                    daysGrid.appendChild(cell);
                }
                monthDiv.appendChild(daysGrid);
                grid.appendChild(monthDiv);
            });
            updateStats();
        }

        function toggleDate(dateStr) {
            if (markedDates.has(dateStr)) markedDates.delete(dateStr);
            else markedDates.add(dateStr);
            initCalendar(); 
        }

        function clearAll() {
            if(confirm(`Alle Markierungen für ${currentYear} löschen?`)) {
                const tempSet = new Set(markedDates);
                tempSet.forEach(date => {
                    if (date.startsWith(String(currentYear))) markedDates.delete(date);
                });
                initCalendar();
            }
        }

        function openDayModal() {
            document.getElementById('modal-year').innerText = currentYear;
            document.getElementById('day-modal').classList.remove('hidden');
        }

        function closeDayModal() {
            document.getElementById('day-modal').classList.add('hidden');
            document.querySelectorAll('#day-modal input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        function markSelectedDays() {
            const checkboxes = document.querySelectorAll('#day-modal input[type="checkbox"]:checked');
            const selectedDays = Array.from(checkboxes).map(cb => parseInt(cb.value));
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time for accurate date-only comparison

            if (selectedDays.length > 0) {
                for (let m = 0; m < 12; m++) {
                    const daysInMonth = new Date(currentYear, m + 1, 0).getDate();
                    for (let d = 1; d <= daysInMonth; d++) {
                        const date = new Date(currentYear, m, d);
                        
                        // Condition: Is a selected weekday AND is not in the future
                        if (selectedDays.includes(date.getDay()) && date <= today) { 
                            markedDates.add(`${currentYear}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`);
                        }
                    }
                }
            }
            initCalendar();
            closeDayModal();
        }

        // --- STATISTICS ---
        function updateStats() {
            const currentYearDates = Array.from(markedDates).filter(d => d.startsWith(String(currentYear)));
            
            document.getElementById('total-count').innerText = currentYearDates.length;

            const weekdayCounts = new Array(7).fill(0); 
            const weekCounts = new Array(54).fill(0); 

            currentYearDates.forEach(dateStr => {
                const dateObj = new Date(dateStr);
                weekdayCounts[dateObj.getDay()]++;

                const weekNo = getISOWeek(dateStr);
                weekCounts[weekNo]++;
            });

            // Weekly
            if (weekChart) weekChart.destroy();
            const weekLabels = Array.from({length: 53}, (_, i) => i + 1);
            weekChart = new Chart(document.getElementById('weekChart'), {
                type: 'line',
                data: {
                    labels: weekLabels,
                    datasets: [{ data: weekCounts.slice(1, 54), borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.3, pointRadius: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } }, x: { ticks: { font: { size: 8 }, maxRotation: 0, autoSkip: true, maxTicksLimit: 10 } } } }
            });

            // Weekday
            if (weekdayChart) weekdayChart.destroy();
            weekdayChart = new Chart(document.getElementById('weekdayChart'), {
                type: 'bar',
                data: {
                    labels: ["Mo", "Di", "Mi", "Do", "Fr", "Sa", "So"],
                    datasets: [{ data: [weekdayCounts[1], weekdayCounts[2], weekdayCounts[3], weekdayCounts[4], weekdayCounts[5], weekdayCounts[6], weekdayCounts[0]], backgroundColor: '#3b82f6', borderRadius: 2 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } }, x: { ticks: { font: { size: 9 } } } } }
            });
        }

        // --- EXPORTS ---
        function downloadPDF() {
            const element = document.getElementById('calendar-content');
            const opt = {
                margin: [10, 10],
                filename: `Kalender_${currentYear}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, ignoreElements: (el) => el.classList.contains('no-print') },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };
            html2pdf().set(opt).from(element).save();
        }

        function downloadJSON() {
            const data = Array.from(markedDates).sort();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kalender_export.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function uploadJSON(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData)) {
                        markedDates = new Set(importedData);
                        initCalendar();
                    }
                } catch (err) { alert("Fehler beim Laden."); }
                input.value = '';
            };
            reader.readAsText(file);
        }

        window.onload = initCalendar;
    </script>
</body>
</html>